<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <title>‰ªäÊó•„ÅØ„Å©„Çì„Å™1Êó•Ôºü</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      background: linear-gradient(135deg, #FFF7ED 0%, #FFEDD5 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    h1 {
      color: #ea580c;
      font-size: 2rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }
    .subtitle {
      color: #78716c;
      font-size: 1.1rem;
      margin-bottom: 2rem;
    }

    /* ÈÅ∏ÊäûÁîªÈù¢ */
    #selection { width: 100%; max-width: 400px; }
    .mood-buttons {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .mood-btn {
      background: white;
      border: none;
      border-radius: 1.5rem;
      padding: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .mood-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .mood-btn:active {
      transform: scale(0.98);
    }
    .mood-btn img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
    }
    .mood-btn span {
      font-size: 1.5rem;
      font-weight: 700;
      color: #44403c;
    }

    /* ÁµêÊûúÁîªÈù¢ */
    #result {
      display: none;
      text-align: center;
      width: 100%;
      max-width: 400px;
    }
    .character-img {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid white;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      margin-bottom: 1.5rem;
    }
    .speech-bubble {
      background: white;
      border-radius: 1.5rem;
      padding: 2rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      position: relative;
      margin-bottom: 2rem;
    }
    .speech-bubble::before {
      content: '';
      position: absolute;
      top: -15px;
      left: 50%;
      transform: translateX(-50%);
      border: 15px solid transparent;
      border-bottom-color: white;
    }
    .character-name {
      color: #ea580c;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    .quote {
      font-size: 1.3rem;
      color: #44403c;
      line-height: 1.8;
    }
    .back-btn {
      background: #ea580c;
      color: white;
      border: none;
      border-radius: 2rem;
      padding: 1rem 3rem;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      box-shadow: 0 4px 15px rgba(234,88,12,0.3);
    }
    .back-btn:hover {
      background: #c2410c;
    }
    .voice-btn {
      background: #fef3c7;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      margin-left: 0.5rem;
      font-size: 1.2rem;
    }
    .name-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- ÈÅ∏ÊäûÁîªÈù¢ -->
  <div id="selection">
    <h1>‰ªäÊó•„ÅØ„Å©„Çì„Å™1Êó•„Å†„Å£„ÅüÔºü</h1>
    <p class="subtitle">Ê∞óÂàÜ„ÇíÈÅ∏„Çì„Åß„Å≠</p>
    <div class="mood-buttons">
      <button class="mood-btn" onclick="selectMood('happy')">
        <img src="img/img1.png" alt="Âπ∏„Åõ">
        <span>Âπ∏„Åõ„Å†„Å£„Åü</span>
      </button>
      <button class="mood-btn" onclick="selectMood('normal')">
        <img src="img/img2.png" alt="ÊôÆÈÄö">
        <span>ÊôÆÈÄö</span>
      </button>
      <button class="mood-btn" onclick="selectMood('sad')">
        <img src="img/img3.png" alt="ÊÇ≤„Åó„ÅÑ">
        <span>„Å°„Çá„Å£„Å®ÊÇ≤„Åó„ÅÑ</span>
      </button>
    </div>
  </div>

  <!-- ÁµêÊûúÁîªÈù¢ -->
  <div id="result">
    <img id="charImg" class="character-img" src="" alt="">
    <div class="speech-bubble">
      <div class="name-row">
        <span id="charName" class="character-name"></span>
        <button class="voice-btn" onclick="playVoice()">üîä</button>
      </div>
      <p id="quote" class="quote"></p>
    </div>
    <button class="back-btn" onclick="closeWindow()">Èñâ„Åò„Çã</button>
  </div>

  <script>
    // „Ç≠„É£„É©„ÇØ„Çø„Éº„Éá„Éº„ÇøÔºàÈü≥Â£∞Ë®≠ÂÆö„ÇíËá™ÁÑ∂„Å´Ë™øÊï¥Ôºâ
    const CHARACTERS = {
      uncle: {
        name: 'Êò≠Âíå„ÅÆ„Åä„Å£„Å°„ÇÉ„Çì',
        image: 'img/img4.png',
        pitch: 0.9,
        rate: 1.0
      },
      auntie: {
        name: '‰∏ñË©±ÁÑº„Åç„ÅÆ„Åä„Å∞„Å°„ÇÉ„Çì',
        image: 'img/img5.png',
        pitch: 1.1,
        rate: 0.95
      },
      fortune: {
        name: 'Ë¨é„ÅÆÂç†„ÅÑÂ∏´',
        image: 'img/img6.png',
        pitch: 0.85,
        rate: 0.9
      }
    };

    // „Çª„É™„Éï„Éá„Éº„Çø
    const QUOTES = {
      happy: {
        uncle: [
          '„Åä„Å£ÔºÅ„Åà„ÅàÈ°î„Åó„Å¶„Çã„Å™ÔºÅ„Åù„ÅÆË™øÂ≠ê„ÅßÊòéÊó•„ÇÇÁ¨ë„Å£„Å®„Åë„ÇàÔºÅ',
          '„Åä„ÅÜ„ÄÅÊôØÊ∞óËâØ„Åï„Åù„ÅÜ„ÇÑ„Å™ÔºÅ‰ø∫„Å´„ÇÇ„Åù„ÅÆÈÅãÊ∞óÂàÜ„Åë„Å¶„Åè„Çå„ÇÑÔºÅ',
          '„Å∏„Å∏„Å£„ÄÅ„ÅÑ„ÅÑ„Åì„Å®„Åå„ÅÇ„Å£„ÅüÊó•„ÅØÈÖí„Åå„ÅÜ„ÇÅ„Åá„ÇÇ„Çì„Å†„ÄÇ„ÇÜ„Å£„Åè„Çä‰ºë„ÇÅ„ÇàÔºÅ'
        ],
        auntie: [
          '„ÅÇ„Çâ„ÄúÔºÅ„ÅÑ„ÅÑ„Åì„Å®„Åå„ÅÇ„Å£„Åü„ÅÆÔºüÈ°îËâ≤„Åå„Å®„Å£„Å¶„ÇÇÁ¥†Êïµ„ÇàÔºÅ',
          '„Çà„Åã„Å£„Åü„Çè„Å≠„ÅáÔºÅ„Åù„ÅÜ„ÅÑ„ÅÜÊó•„ÅØ„ÄÅÁæéÂë≥„Åó„ÅÑ„ÅäËå∂„Åß„ÇÇÈ£≤„Çì„Åß„ÇÜ„Å£„Åè„Çä„Åó„Å¶„Å≠„ÄÇ',
          '„Åµ„Åµ„ÄÅ„ÅÇ„Å™„Åü„ÅÆÁ¨ëÈ°î„ÅåË¶ã„Çâ„Çå„Å¶ÁßÅ„ÇÇÂ¨â„Åó„ÅÑ„Çè„ÄÇÊòéÊó•„ÇÇ„ÅÑ„ÅÑÊó•„Å´„Å™„Çã„Çè„ÇàÔºÅ'
        ],
        fortune: [
          '„Åª„Åª„ÅÜ‚Ä¶Ëºù„Åè„Ç™„Éº„É©„ÅåË¶ã„Åà„Çã„Åû‚Ä¶‰ªäÊó•„ÅÆÊ±ù„ÅØÊòü„Å´ÊÑõ„Åï„Çå„Å¶„Åä„Çã„Å™„ÄÇ',
          'ÂêâÂÖÜ„Åò„ÇÉ„ÄÇ„Åù„ÅÆÁ¨ëÈ°î„Åå„ÄÅÊòéÊó•„ÅÆÈÅãÂëΩ„Çí„Åï„Çâ„Å´Âºï„ÅçÂØÑ„Åõ„Çã„Åß„ÅÇ„Çç„ÅÜ‚Ä¶„ÄÇ',
          '„Åµ„ÇÄ„ÄÅÊÇ™„Åè„Å™„ÅÑ„ÄÇ‰ªäÊó•„ÅÆÊ±ù„ÅØ„ÄÅÂÆáÂÆô„ÅÆ„É™„Ç∫„É†„Å®Ë™øÂíå„Åó„Å¶„Åä„Çã„Çà„ÅÜ„Åò„ÇÉ„Å™„ÄÇ'
        ]
      },
      normal: {
        uncle: [
          '„Åæ„ÅÇ„ÄÅ‰Ωï„ÇÇ„Å™„ÅÑ„ÅÆ„Åå‰∏ÄÁï™„ÅÆÂπ∏„Åõ„Å£„Å¶„ÇÑ„Å§„Çà„ÄÇÈ¢®ÂëÇÂÖ•„Å£„Å¶ÂØù„ÇçÔºÅ',
          'ÊôÆÈÄö„Åã„ÄÇ‰∫∫Áîü„ÄÅ„Åù„Çì„Å™Êó•„Åå‰∏ÄÁï™Â§ß‰∫ã„Å™„Çì„Å†„Çà„Å™„ÄÇ„ÅäÁñ≤„Çå„Åï„ÇìÔºÅ',
          '„Åä„ÅÜ„ÄÅ‰ªäÊó•„ÇÇÁÑ°‰∫ã„Å´ÁµÇ„Çè„Å£„Åü„Å™„Çâ„Åù„Çå„ÅåÊúÄÈ´ò„Å†„ÄÇÊ∞óÊ•Ω„Å´„ÅÑ„Åì„ÅÜ„ÅúÔºÅ'
        ],
        auntie: [
          '„ÅäÁñ≤„Çå„Åï„ÅæÔºÅ‰ΩïÊ∞ó„Å™„ÅÑ1Êó•„Åì„Åù„Åå„ÄÅÂÆü„ÅØÂÆùÁâ©„Å™„ÅÆ„Çà„Å≠„Åá„ÄÇ',
          '‰ªäÊó•„ÇÇ‰∏ÄÊó•„Çà„ÅèÈ†ëÂºµ„Å£„Åü„Çè„Å≠„ÄÇ„ÅîÈ£Ø„Å°„ÇÉ„Çì„Å®È£ü„Åπ„Å¶„ÄÅÊöñ„Åã„Åè„Åó„Å¶ÂØù„Çã„ÅÆ„Çà„ÄÇ',
          '„ÅÇ„Çâ„ÄÅÊôÆÈÄö„Åå‰∏ÄÁï™„ÇàÔºÅÂπ≥Á©èÁÑ°‰∫ã„ÄÅ„Åù„Çå„ÅåÈï∑Áîü„Åç„ÅÆÁßòË®£„Å£„Å¶„Å≠„ÄÇ'
        ],
        fortune: [
          '„Åµ„ÇÄ‚Ä¶Âá™„ÅÆ„Çà„ÅÜ„Å™‰∏ÄÊó•„Åã„ÄÇ„Åù„Çå„ÇÇ„Åæ„ÅüÈÅãÂëΩ„ÅÆ‰ºëÊÜ©ÊôÇÈñì„Åò„ÇÉ„Çà„ÄÇ',
          'Âπ≥Á©è„Åì„Åù„ÅåÊúÄÂº∑„ÅÆÁõæ„Åò„ÇÉ„ÄÇÊ±ù„ÅÆ‰ªäÊó•„ÅØ„ÄÅÈùô„Åã„Å´ÂÆà„Çâ„Çå„Å¶„Åä„Å£„Åü„Çà„ÅÜ„Åò„ÇÉ„Å™„ÄÇ',
          '‰Ωï„ÇÇËµ∑„Åç„Å¨„Åì„Å®„ÄÅ„Åù„ÇåÂç≥„Å°Â•áË∑°„Å™„Çä„ÄÇ‰ªäÊó•„ÅÆÊ±ù„ÅØ„ÄÅÈùôÂØÇ„Å´ÂåÖ„Åæ„Çå„Å¶„Åä„Çã„ÄÇ'
        ]
      },
      sad: {
        uncle: [
          '„Å™„Çì„Å†„ÄÅËæõÊ∞óËá≠„ÅÑÈ°î„Åó„ÇÑ„Åå„Å£„Å¶ÔºÅÁîü„Åç„Å¶„Çä„ÇÉ„Åù„Çì„Å™Êó•„ÇÇ„ÅÇ„Çã„Åï„ÄÅÊ∞ó„Å´„Åô„Çì„Å™ÔºÅ',
          '„Åä„ÅÑ„Åä„ÅÑ„ÄÅ‰∏ãÂêë„ÅÑ„Å¶Ê≠©„Åè„Å™„ÇàÔºÅÊòéÊó•„ÅØÊòéÊó•„ÅÆÈ¢®„ÅåÂêπ„Åè„Å£„Å¶„Å™ÔºÅ',
          '„Åä„ÅÜ„ÄÅ‰ªäÊó•„ÅØ„Åï„Å£„Åï„Å®ÂØù„Å°„Åæ„ÅàÔºÅÂØù„Å¶Ëµ∑„Åç„Åü„ÇâËÖπ„ÇÇÊ∏õ„Çã„ÅóÂÖÉÊ∞ó„ÇÇÂá∫„Çã„ÅïÔºÅ'
        ],
        auntie: [
          '„ÅÇ„Çâ„ÅÇ„Çâ„ÄÅÂÖÉÊ∞ó„Å™„ÅÑ„Çè„Å≠„Åá„ÄÇ„Åù„Çì„Å™ÊôÇ„ÅØÁîò„ÅÑ„ÇÇ„ÅÆ„Åß„ÇÇÈ£ü„Åπ„Å¶Âøò„Çå„Å°„ÇÉ„ÅÑ„Åæ„Åó„ÇáÔºÅ',
          'Â§ß‰∏àÂ§´„Çà„ÄÅÁßÅ„Åå„Å§„ÅÑ„Å¶„Çã„Çè„ÄÇ‰ªäÊó•„ÅØ„ÇÇ„ÅÜ‰ºë„Çì„Åß„ÄÅÊòéÊó•„Å´ÂÇô„Åà„Åæ„Åó„Çá„ÄÇ',
          'Ëæõ„ÅÑ„Åì„Å®„Åå„ÅÇ„Å£„Åü„ÅÆÔºü„Åß„ÇÇ„Å≠„ÄÅ‰ªäÊó•„Çí‰πó„ÇäË∂ä„Åà„Åü„ÅÇ„Å™„Åü„ÅØÂÅâ„ÅÑÔºÅËä±‰∏∏„ÇàÔºÅ'
        ],
        fortune: [
          'Èõ®Èôç„Å£„Å¶Âú∞Âõ∫„Åæ„Çã‚Ä¶Ê±ù„ÅÆÊ∂ô„ÅØ„ÄÅÊòéÊó•„ÅÆËä±„ÇíÂí≤„Åã„Åõ„Çã„Åü„ÇÅ„ÅÆÊ∞¥„Åò„ÇÉ„Çà„ÄÇ',
          '‰ªä„ÅØÈúß„ÅÆ‰∏≠„Åã„ÇÇ„Åó„Çå„Å¨„Åå„ÄÅÈÅì„ÅØÂøÖ„ÅöÈñã„Åë„Çã„ÄÇÊòü„ÅØÊ±ù„ÇíË¶ãÊç®„Å¶„Å¶„ÅØ„Åä„Çâ„Å¨„ÄÇ',
          'ÊÇ≤„Åó„Åø„ÇÇ„Åæ„Åü„ÄÅ‰∫∫Áîü„ÅÆ„Çπ„Éë„Ç§„Çπ„Åò„ÇÉ„ÄÇÂë≥„Çè„ÅÑÊ∑±„ÅÑ‰∫∫Èñì„Å´„Å™„Çã„Åü„ÇÅ„ÅÆË©¶Á∑¥„Åò„ÇÉ„Å™„ÄÇ'
        ]
      }
    };

    let currentQuote = '';
    let currentCharacter = null;

    // URL„Éë„É©„É°„Éº„Çø„ÉÅ„Çß„ÉÉ„ÇØÔºàLINE LIFFÂØæÂøúÔºâ
    window.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      let mood = params.get('mood');

      // LIFF„ÅÆÂ†¥Âêà„ÄÅliff.state„Åã„ÇâÂèñÂæó
      if (!mood) {
        const liffState = params.get('liff.state');
        if (liffState) {
          const decoded = decodeURIComponent(liffState);
          const stateParams = new URLSearchParams(decoded.replace('?', ''));
          mood = stateParams.get('mood');
        }
      }

      if (mood && ['happy', 'normal', 'sad'].includes(mood)) {
        selectMood(mood);
      }
    });

    function selectMood(mood) {
      // „É©„É≥„ÉÄ„É†„Å´„Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû
      const charKeys = Object.keys(CHARACTERS);
      const charKey = charKeys[Math.floor(Math.random() * charKeys.length)];
      currentCharacter = CHARACTERS[charKey];

      // „É©„É≥„ÉÄ„É†„Å´„Çª„É™„ÉïÈÅ∏Êäû
      const quotes = QUOTES[mood][charKey];
      currentQuote = quotes[Math.floor(Math.random() * quotes.length)];

      // ÁîªÈù¢Êõ¥Êñ∞
      document.getElementById('charImg').src = currentCharacter.image;
      document.getElementById('charName').textContent = currentCharacter.name;
      document.getElementById('quote').textContent = '„Äå' + currentQuote + '„Äç';

      // ÁîªÈù¢Âàá„ÇäÊõø„Åà
      document.getElementById('selection').classList.add('hidden');
      document.getElementById('result').classList.remove('hidden');
      document.getElementById('result').style.display = 'block';

      // Èü≥Â£∞ÂÜçÁîüÔºàÂ∞ë„ÅóÈÅÖÂª∂Ôºâ
      setTimeout(playVoice, 200);

      // APIÈÄÅ‰ø°ÔºàË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
      sendMoodToAPI(mood);
    }

    function playVoice() {
      if (!window.speechSynthesis || !currentQuote) return;

      window.speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(currentQuote);
      utterance.lang = 'ja-JP';
      utterance.pitch = currentCharacter.pitch;
      utterance.rate = currentCharacter.rate;
      utterance.volume = 1.0;

      const voices = window.speechSynthesis.getVoices();
      // È´òÂìÅË≥™„Å™Êó•Êú¨Ë™ûÈü≥Â£∞„ÇíÂÑ™ÂÖàÔºàKyoko, Otoya, GoogleÊó•Êú¨Ë™ûÔºâ
      let jpVoice = voices.find(v => v.name.includes('Kyoko'));
      if (!jpVoice) jpVoice = voices.find(v => v.name.includes('Google') && v.lang.startsWith('ja'));
      if (!jpVoice) jpVoice = voices.find(v => v.name.includes('Otoya'));
      if (!jpVoice) jpVoice = voices.find(v => v.lang === 'ja-JP' || v.lang === 'ja_JP');

      if (jpVoice) utterance.voice = jpVoice;

      window.speechSynthesis.speak(utterance);
    }

    function closeWindow() {
      window.speechSynthesis.cancel();
      // LIFF„Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñâ„Åò„Çã
      try {
        window.close();
      } catch (e) {
        // Èñâ„Åò„Çâ„Çå„Å™„ÅÑÂ†¥Âêà„ÅØLINE„Å´Êàª„ÇãÊ°àÂÜÖ
        alert('Âè≥‰∏ä„ÅÆ√ó„Éú„Çø„É≥„ÅßÈñâ„Åò„Å¶„Åè„Å†„Åï„ÅÑ');
      }
    }

    function sendMoodToAPI(mood) {
      // API_ENDPOINT „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞ÈÄÅ‰ø°
      const API_ENDPOINT = 'https://ftc.potz.jp/api';
      if (!API_ENDPOINT) return;

      fetch(API_ENDPOINT + '/mood', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          mood: mood,
          timestamp: new Date().toISOString()
        })
      }).catch(console.error);
    }

    // Èü≥Â£∞„É™„Çπ„ÉàË™≠„ÅøËæº„Åø
    if (window.speechSynthesis) {
      speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
    }
  </script>
</body>
</html>
